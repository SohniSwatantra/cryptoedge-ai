<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - CryptoEdge AI</title>
    <link rel="icon" href="/favicon.ico" sizes="48x48">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#0C1616">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0c1616;
            --bg-secondary: #111c1c;
            --bg-card: #162121;
            --accent: #3ecf8e;
            --accent-green: #3ecf8e;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --text-primary: #f0f0f0;
            --text-secondary: #7a8a8a;
            --border: #1e2e2e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Top bar */
        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .topbar .logo {
            display: flex;
            align-items: center;
            gap: 0;
            font-size: 20px;
            font-weight: 600;
            text-decoration: none;
            color: var(--text-primary);
            font-family: Georgia, 'Times New Roman', serif;
            letter-spacing: -0.5px;
        }
        .topbar .logo-icon {
            display: none;
        }
        .topbar-right { display: flex; align-items: center; gap: 20px; }
        .user-info { font-size: 14px; color: var(--text-secondary); }
        .user-info strong { color: var(--text-primary); }
        .btn-sm {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn-logout { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); border-radius: 100px; }
        .btn-logout:hover { border-color: #3a4a4a; color: var(--text-primary); }

        /* Layout */
        .dashboard { padding: 24px 32px; max-width: 1400px; margin: 0 auto; }

        /* Live ticker strip */
        .ticker-strip {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            overflow-x: auto;
        }
        .ticker-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 24px;
            min-width: 220px;
            flex-shrink: 0;
        }
        .ticker-pair { font-size: 14px; font-weight: 700; margin-bottom: 4px; }
        .ticker-price { font-size: 24px; font-weight: 400; font-family: Georgia, 'Times New Roman', serif; letter-spacing: -0.5px; }
        .ticker-change { font-size: 13px; margin-top: 2px; }
        .green { color: var(--accent-green); }
        .red { color: var(--accent-red); }

        /* Portfolio cards */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .port-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        .port-label { font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .port-value { font-size: 24px; font-weight: 400; font-family: Georgia, 'Times New Roman', serif; letter-spacing: -0.5px; }

        /* Sections */
        .section-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }
        .section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 24px;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .section h3 { font-size: 16px; font-weight: 600; }

        /* Signal cards */
        .signal-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .signal-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .signal-pair { font-weight: 700; }
        .signal-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .badge-long { background: rgba(62,207,142,0.15); color: var(--accent-green); border: 1px solid rgba(62,207,142,0.3); }
        .badge-short { background: rgba(248,113,113,0.15); color: var(--accent-red); border: 1px solid rgba(248,113,113,0.3); }
        .badge-hold { background: rgba(148,163,184,0.15); color: var(--text-secondary); border: 1px solid var(--border); }
        .signal-confidence { font-size: 13px; color: var(--text-secondary); }
        .signal-indicators { display: flex; gap: 12px; font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
        .signal-indicators span { background: var(--bg-primary); padding: 3px 8px; border-radius: 4px; }

        /* Trade form */
        .trade-form { display: flex; flex-direction: column; gap: 12px; }
        .form-row { display: flex; gap: 12px; }
        .form-row > * { flex: 1; }
        .trade-form label { font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px; }
        .trade-form input, .trade-form select {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
        }
        .trade-form input:focus, .trade-form select:focus { border-color: var(--accent); }
        .btn-trade {
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            border: none;
            color: white;
            transition: all 0.2s;
        }
        .btn-long { background: var(--accent-green); color: #0c1616; }
        .btn-long:hover { opacity: 0.85; }
        .btn-short { background: var(--accent-red); color: #0c1616; }
        .btn-short:hover { opacity: 0.85; }
        .trade-buttons { display: flex; gap: 12px; }
        .trade-buttons button { flex: 1; }

        /* Positions table */
        .pos-table { width: 100%; border-collapse: collapse; }
        .pos-table th {
            text-align: left;
            padding: 10px 12px;
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }
        .pos-table td {
            padding: 10px 12px;
            font-size: 13px;
            border-bottom: 1px solid rgba(30,46,46,0.7);
        }
        .btn-close-pos {
            padding: 4px 12px;
            background: rgba(248,113,113,0.15);
            border: 1px solid rgba(248,113,113,0.3);
            color: var(--accent-red);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-close-pos:hover { background: rgba(248,113,113,0.3); }

        .pnl-positive { color: var(--accent-green); font-weight: 600; }
        .pnl-negative { color: var(--accent-red); font-weight: 600; }
        .pnl-cell { white-space: nowrap; }
        .pos-table tr { cursor: pointer; transition: background 0.15s; }
        .pos-table thead tr { cursor: default; }
        .pos-table tbody tr:hover { background: rgba(62,207,142,0.04); }

        /* Position Detail Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.25s;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            background: var(--bg-card); border: 1px solid var(--border);
            border-radius: 16px; padding: 28px 32px; width: 520px; max-width: 95vw;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h3 { font-size: 18px; font-family: Georgia, 'Times New Roman', serif; font-weight: 400; }
        .modal-close {
            background: none; border: none; color: var(--text-secondary);
            font-size: 22px; cursor: pointer; padding: 4px 8px; border-radius: 6px;
        }
        .modal-close:hover { color: var(--text-primary); background: var(--bg-secondary); }
        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
        }
        .detail-item { background: var(--bg-secondary); border-radius: 8px; padding: 14px; }
        .detail-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .detail-value { font-size: 16px; font-weight: 600; }
        .detail-full { grid-column: 1 / -1; }
        .detail-divider { grid-column: 1 / -1; height: 1px; background: var(--border); margin: 4px 0; }
        .pnl-banner {
            grid-column: 1 / -1; text-align: center; padding: 20px;
            border-radius: 10px; margin-top: 4px;
        }
        .pnl-banner.positive { background: rgba(62,207,142,0.1); border: 1px solid rgba(62,207,142,0.2); }
        .pnl-banner.negative { background: rgba(248,113,113,0.1); border: 1px solid rgba(248,113,113,0.2); }
        .pnl-banner .pnl-amount { font-size: 28px; font-weight: 400; font-family: Georgia, 'Times New Roman', serif; }
        .pnl-banner .pnl-percent { font-size: 14px; margin-top: 2px; }

        .empty-state { text-align: center; padding: 32px; color: var(--text-secondary); font-size: 14px; }

        /* LLM Signal Analysis Styles */
        .signal-analysis {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 6px;
        }
        .signal-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .signal-sentiment {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .sentiment-bullish { background: rgba(62,207,142,0.15); color: var(--accent-green); }
        .sentiment-bearish { background: rgba(248,113,113,0.15); color: var(--accent-red); }
        .sentiment-neutral { background: rgba(148,163,184,0.15); color: var(--text-secondary); }
        .risk-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .risk-low { background: rgba(62,207,142,0.1); color: var(--accent-green); }
        .risk-medium { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .risk-high { background: rgba(248,113,113,0.1); color: var(--accent-red); }
        .ai-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(167,139,250,0.15);
            color: var(--accent-purple);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .signal-factors {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        .signal-factor-tag {
            padding: 3px 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        .signal-levels {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        .signal-level-item {
            text-align: center;
            padding: 6px;
            background: var(--bg-primary);
            border-radius: 6px;
        }
        .signal-level-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .signal-level-value {
            font-size: 13px;
            font-weight: 600;
            margin-top: 2px;
        }
        .signal-liquidity {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(59,130,246,0.06);
            border: 1px solid rgba(59,130,246,0.15);
            border-radius: 6px;
        }
        .signal-liquidity-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #60a5fa;
            margin-bottom: 3px;
        }
        .signal-error {
            text-align: center;
            padding: 24px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px 20px;
            font-size: 14px;
            z-index: 200;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { border-color: var(--accent-green); }
        .toast.error { border-color: var(--accent-red); }

        /* Full width section */
        .full-section { margin-bottom: 24px; }

        /* Connection status */
        .ws-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        .ws-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--accent-red);
        }
        .ws-dot.connected { background: var(--accent-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.5;} }

        /* Analytics */
        .analytics-section { margin-bottom: 24px; }
        .analytics-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        .analytics-row { display: flex; gap: 16px; margin-bottom: 16px; }
        .analytics-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        .analytics-card h4 { font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .analytics-card-sm { width: 220px; flex-shrink: 0; }
        .analytics-card-md { flex: 1; min-width: 0; }
        .analytics-card-lg { flex: 1; min-width: 0; }
        .donut-wrap { position: relative; width: 140px; height: 140px; margin: 0 auto; }
        .donut-wrap canvas { display: block; }
        .donut-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center;
        }
        .donut-center .donut-pct { font-size: 28px; font-weight: 400; font-family: Georgia, 'Times New Roman', serif; color: var(--text-primary); }
        .donut-center .donut-label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
        .streak-dots { display: flex; gap: 6px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
        .streak-dot {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; font-weight: 700; color: #0c1616;
        }
        .streak-dot.win { background: var(--accent-green); }
        .streak-dot.loss { background: var(--accent-red); }
        .streak-dot.even { background: var(--text-secondary); }
        .streak-info { text-align: center; margin-top: 10px; font-size: 13px; color: var(--text-secondary); }
        .streak-info strong { color: var(--text-primary); }
        .analytics-empty {
            text-align: center; padding: 48px 24px; color: var(--text-secondary); font-size: 14px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
        }

        /* Table scroll wrapper */
        .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        /* Safe area for PWA notch */
        .topbar { padding-top: max(16px, env(safe-area-inset-top)); }
        .dashboard { padding-bottom: max(24px, env(safe-area-inset-bottom)); }

        @media (max-width: 768px) {
            .dashboard { padding: 12px; }
            .topbar { padding: 10px 12px; padding-top: max(10px, env(safe-area-inset-top)); }
            .topbar .logo { font-size: 16px; }
            .topbar-right { gap: 10px; }
            .topbar-right .user-info { display: none; }
            .ws-status span { display: none; }
            .btn-logout { padding: 6px 12px; font-size: 12px; }

            .ticker-strip { gap: 10px; margin-bottom: 16px; }
            .ticker-item { min-width: 160px; padding: 12px 16px; }
            .ticker-price { font-size: 20px; }
            .ticker-pair { font-size: 12px; }

            .portfolio-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
            .port-card { padding: 14px; }
            .port-label { font-size: 10px; }
            .port-value { font-size: 18px; }

            .section-grid { grid-template-columns: 1fr; gap: 16px; margin-bottom: 16px; }
            .section { padding: 16px; border-radius: 12px; }
            .section h3 { font-size: 14px; }
            .section-header { flex-wrap: wrap; gap: 8px; }

            .signal-card { padding: 12px; }
            .signal-levels { grid-template-columns: repeat(3, 1fr); gap: 6px; }

            .form-row { flex-direction: column; }
            .trade-form label { font-size: 11px; }
            .btn-trade { padding: 10px; font-size: 13px; }

            .full-section { margin-bottom: 16px; }
            .full-section .section-header { margin-bottom: 12px; }

            .pos-table th { padding: 8px; font-size: 10px; }
            .pos-table td { padding: 8px; font-size: 12px; }

            .modal-content { padding: 20px 16px; border-radius: 12px; max-width: 100vw; width: calc(100vw - 24px); }
            .modal-header h3 { font-size: 16px; }
            .detail-grid { gap: 10px; }
            .detail-item { padding: 10px; }
            .detail-value { font-size: 14px; }
            .pnl-banner .pnl-amount { font-size: 22px; }

            .analytics-section h3 { font-size: 14px; margin-bottom: 12px; }
            .analytics-row { flex-direction: column; gap: 12px; margin-bottom: 12px; }
            .analytics-card { padding: 16px; }
            .analytics-card-sm { width: 100%; }
            .analytics-card h4 { font-size: 12px; margin-bottom: 8px; }

            .toast { left: 12px; right: 12px; bottom: max(12px, env(safe-area-inset-bottom)); }
        }

        @media (max-width: 380px) {
            .portfolio-grid { grid-template-columns: 1fr; }
            .port-value { font-size: 16px; }
            .detail-grid { grid-template-columns: 1fr; }
            .ticker-item { min-width: 140px; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="topbar">
        <a href="/" class="logo">
            CryptoEdge<span style="color:var(--text-secondary);font-weight:400;">.</span>
        </a>
        <div class="topbar-right">
            <div class="ws-status">
                <div class="ws-dot" id="wsDot"></div>
                <span id="wsLabel">Disconnected</span>
            </div>
            <div class="user-info">Welcome, <strong id="userName">-</strong></div>
            <button class="btn-sm btn-logout" onclick="logout()">Log Out</button>
        </div>
    </div>

    <div class="dashboard">
        <!-- Live Ticker Strip -->
        <div class="ticker-strip" id="tickerStrip">
            <div class="ticker-item">
                <div class="ticker-pair">&#8383; BTC / EUR</div>
                <div class="ticker-price" id="btcPrice">Loading...</div>
                <div class="ticker-change" id="btcChange">-</div>
            </div>
            <div class="ticker-item">
                <div class="ticker-pair">&#926; ETH / EUR</div>
                <div class="ticker-price" id="ethPrice">Loading...</div>
                <div class="ticker-change" id="ethChange">-</div>
            </div>
        </div>

        <!-- Portfolio Summary -->
        <div class="portfolio-grid" id="portfolioGrid">
            <div class="port-card">
                <div class="port-label">Cash Balance</div>
                <div class="port-value" id="cashBalance">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Invested</div>
                <div class="port-value" id="investedAmount">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Total Value</div>
                <div class="port-value" id="totalValue">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Realized P&L</div>
                <div class="port-value" id="totalPnl">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Unrealized P&L</div>
                <div class="port-value" id="unrealizedPnl">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Win Rate</div>
                <div class="port-value" id="winRate">-</div>
            </div>
            <div class="port-card">
                <div class="port-label">Total Trades</div>
                <div class="port-value" id="totalTrades">-</div>
            </div>
        </div>

        <!-- Signals + Quick Trade -->
        <div class="section-grid">
            <!-- AI Signals -->
            <div class="section">
                <div class="section-header">
                    <h3>AI Signals (Live)</h3>
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button class="btn-sm" id="refreshSignalsBtn" onclick="manualRefreshSignals()" style="background:transparent;border:1px solid var(--border);color:var(--text-secondary);border-radius:100px;padding:5px 12px;font-size:12px;cursor:pointer;" title="Generate fresh signals now">&#x21bb; Refresh</button>
                        <span style="font-size:12px;color:var(--text-secondary);" id="signalTime">-</span>
                    </div>
                </div>
                <div id="signalsList">
                    <div class="empty-state">Waiting for signals...</div>
                </div>
            </div>

            <!-- Quick Trade -->
            <div class="section">
                <h3 style="margin-bottom:16px;">Quick Trade (Paper)</h3>
                <div class="trade-form" id="tradeForm">
                    <div class="form-row">
                        <div>
                            <label>Pair</label>
                            <select id="tradePair">
                                <option value="BTC/EUR">BTC/EUR</option>
                                <option value="ETH/EUR">ETH/EUR</option>
                            </select>
                        </div>
                        <div>
                            <label>Quantity</label>
                            <input type="number" id="tradeQty" step="0.001" min="0.001" placeholder="0.01" value="0.01">
                        </div>
                    </div>
                    <div class="form-row">
                        <div>
                            <label>Stop Loss (optional)</label>
                            <input type="number" id="tradeSL" step="0.01" placeholder="Auto">
                        </div>
                        <div>
                            <label>Take Profit (optional)</label>
                            <input type="number" id="tradeTP" step="0.01" placeholder="Auto">
                        </div>
                    </div>
                    <div class="trade-buttons">
                        <button class="btn-trade btn-long" onclick="placeTrade('long')">&#9650; Long</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="section full-section">
            <div class="section-header">
                <h3>Open Positions</h3>
                <span style="font-size:13px;color:var(--text-secondary);" id="posCount">0 open</span>
            </div>
            <div id="positionsContainer">
                <div class="empty-state">No open positions. Place a trade to get started.</div>
            </div>
        </div>

        <!-- Trade History -->
        <div class="section full-section">
            <div class="section-header">
                <h3>Trade History</h3>
            </div>
            <div id="historyContainer">
                <div class="empty-state">No closed trades yet.</div>
            </div>
        </div>

        <!-- Performance Analytics -->
        <div class="analytics-section" id="analyticsSection">
            <h3>Performance Analytics</h3>
            <div id="analyticsEmpty" class="analytics-empty" style="display:none;">
                Complete some trades to see your performance analytics.
            </div>
            <div id="analyticsContent" style="display:none;">
                <div class="analytics-row">
                    <div class="analytics-card analytics-card-sm">
                        <h4>Win Rate</h4>
                        <div class="donut-wrap">
                            <canvas id="donutCanvas" width="140" height="140"></canvas>
                            <div class="donut-center">
                                <div class="donut-pct" id="donutPct">-</div>
                                <div class="donut-label">Win Rate</div>
                            </div>
                        </div>
                    </div>
                    <div class="analytics-card analytics-card-sm">
                        <h4>Recent Streak</h4>
                        <div id="streakContainer"></div>
                    </div>
                    <div class="analytics-card analytics-card-lg">
                        <h4>Cumulative P&amp;L</h4>
                        <canvas id="pnlCanvas" height="180"></canvas>
                    </div>
                </div>
                <div class="analytics-row">
                    <div class="analytics-card analytics-card-md">
                        <h4>Win Rate by Pair</h4>
                        <canvas id="pairCanvas" height="160"></canvas>
                    </div>
                    <div class="analytics-card analytics-card-md">
                        <h4>Win Rate by Direction</h4>
                        <canvas id="dirCanvas" height="160"></canvas>
                    </div>
                    <div class="analytics-card analytics-card-md">
                        <h4>Confidence Calibration</h4>
                        <canvas id="calibCanvas" height="160"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Position Detail Modal -->
    <div class="modal-overlay" id="posDetailModal" onclick="if(event.target===this)closeDetailModal()">
        <div class="modal-content" id="posDetailContent"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
    const API = '';
    let token = localStorage.getItem('cryptoedge_token');
    let ws = null;
    let latestTickers = {};
    let openPositions = [];
    let closedTrades = [];

    // Auth check
    if (!token) { window.location.href = '/'; }

    function headers() { return { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }; }

    function logout() {
        localStorage.removeItem('cryptoedge_token');
        localStorage.removeItem('cryptoedge_user');
        window.location.href = '/';
    }

    function showToast(msg, type = 'success') {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.className = 'toast ' + type + ' show';
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function fmt(num, decimals = 2) {
        return '\u20AC' + parseFloat(num).toLocaleString(undefined, { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    function calcUnrealizedPnl(position, currentPrice) {
        if (!currentPrice) return null;
        if (position.direction === 'long') {
            return (currentPrice - position.entry_price) * position.quantity;
        } else {
            return (position.entry_price - currentPrice) * position.quantity;
        }
    }

    function calcPnlPercent(position, pnl) {
        const invested = position.entry_price * position.quantity;
        return invested > 0 ? (pnl / invested) * 100 : 0;
    }

    function getCurrentPriceForPair(pair) {
        return latestTickers[pair]?.price || null;
    }

    function formatDuration(start, end) {
        const ms = new Date(end) - new Date(start);
        const mins = Math.floor(ms / 60000);
        if (mins < 60) return mins + 'm';
        const hrs = Math.floor(mins / 60);
        if (hrs < 24) return hrs + 'h ' + (mins % 60) + 'm';
        const days = Math.floor(hrs / 24);
        return days + 'd ' + (hrs % 24) + 'h';
    }

    function updateUnrealizedPnlCard() {
        const el = document.getElementById('unrealizedPnl');
        if (openPositions.length === 0) {
            el.textContent = fmt(0);
            el.className = 'port-value';
            return;
        }
        let totalUnrealized = 0;
        let hasPrices = false;
        for (const p of openPositions) {
            const price = getCurrentPriceForPair(p.pair);
            if (price) {
                hasPrices = true;
                totalUnrealized += calcUnrealizedPnl(p, price);
            }
        }
        if (!hasPrices) { el.textContent = '-'; return; }
        el.textContent = (totalUnrealized >= 0 ? '+' : '') + fmt(totalUnrealized);
        el.className = 'port-value ' + (totalUnrealized >= 0 ? 'green' : 'red');
    }

    // Load user info
    async function loadUser() {
        try {
            const res = await fetch(API + '/api/auth/me', { headers: headers() });
            if (!res.ok) { logout(); return; }
            const data = await res.json();
            document.getElementById('userName').textContent = data.user.name;
        } catch { logout(); }
    }

    // Load portfolio
    async function loadPortfolio() {
        try {
            const res = await fetch(API + '/api/portfolio/summary', { headers: headers() });
            const data = await res.json();
            const s = data.summary;
            document.getElementById('cashBalance').textContent = fmt(s.cash_balance);
            document.getElementById('investedAmount').textContent = fmt(s.invested);
            document.getElementById('totalValue').textContent = fmt(s.total_value);
            const pnlEl = document.getElementById('totalPnl');
            pnlEl.textContent = (s.total_pnl >= 0 ? '+' : '') + fmt(s.total_pnl);
            pnlEl.className = 'port-value ' + (s.total_pnl >= 0 ? 'green' : 'red');
            document.getElementById('winRate').textContent = s.win_rate + '%';
            document.getElementById('totalTrades').textContent = s.total_trades;
        } catch (err) { console.error('Portfolio error:', err); }
    }

    // Load positions
    async function loadPositions() {
        try {
            const res = await fetch(API + '/api/trade/positions', { headers: headers() });
            const data = await res.json();
            openPositions = data.positions;
            renderPositions();
        } catch (err) { console.error('Positions error:', err); }
    }

    function renderPositions() {
        const c = document.getElementById('positionsContainer');
        document.getElementById('posCount').textContent = openPositions.length + ' open';
        if (openPositions.length === 0) {
            c.innerHTML = '<div class="empty-state">No open positions. Place a trade to get started.</div>';
            updateUnrealizedPnlCard();
            return;
        }
        c.innerHTML = '<div class="table-scroll"><table class="pos-table"><thead><tr><th>Pair</th><th>Dir</th><th>Entry</th><th>Current</th><th>Qty</th><th>P&L</th><th>%</th><th>Opened</th><th></th></tr></thead><tbody>' +
            openPositions.map(p => {
                const curPrice = getCurrentPriceForPair(p.pair);
                const pnl = curPrice ? calcUnrealizedPnl(p, curPrice) : null;
                const pnlPct = pnl !== null ? calcPnlPercent(p, pnl) : null;
                const pnlClass = pnl !== null ? (pnl >= 0 ? 'pnl-positive' : 'pnl-negative') : '';
                return `<tr onclick="showPositionDetail(${p.id})" title="Click for details">
                    <td><strong>${p.pair}</strong></td>
                    <td><span class="signal-badge badge-${p.direction}">${p.direction}</span></td>
                    <td>${fmt(p.entry_price)}</td>
                    <td>${curPrice ? fmt(curPrice) : '<span style="color:var(--text-secondary)">--</span>'}</td>
                    <td>${p.quantity}</td>
                    <td class="pnl-cell ${pnlClass}">${pnl !== null ? (pnl >= 0 ? '+' : '') + fmt(pnl) : '--'}</td>
                    <td class="pnl-cell ${pnlClass}">${pnlPct !== null ? (pnlPct >= 0 ? '+' : '') + pnlPct.toFixed(2) + '%' : '--'}</td>
                    <td>${new Date(p.created_at).toLocaleString()}</td>
                    <td><button class="btn-close-pos" onclick="event.stopPropagation();closeTrade(${p.id})">Close</button></td>
                </tr>`;
            }).join('') + '</tbody></table></div>';
        updateUnrealizedPnlCard();
    }

    // Load trade history
    async function loadHistory() {
        try {
            const res = await fetch(API + '/api/trade/history', { headers: headers() });
            const data = await res.json();
            closedTrades = data.trades;
            const c = document.getElementById('historyContainer');
            if (closedTrades.length === 0) {
                c.innerHTML = '<div class="empty-state">No closed trades yet.</div>';
                return;
            }
            c.innerHTML = '<div class="table-scroll"><table class="pos-table"><thead><tr><th>Pair</th><th>Dir</th><th>Entry</th><th>Exit</th><th>Qty</th><th>P&L</th><th>%</th><th>Time</th><th>Closed</th></tr></thead><tbody>' +
                closedTrades.map((t, idx) => {
                    const invested = t.entry_price * t.quantity;
                    const pctReturn = invested > 0 ? (t.pnl / invested) * 100 : 0;
                    const duration = t.created_at && t.closed_at ? formatDuration(t.created_at, t.closed_at) : '-';
                    return `<tr onclick="showHistoryDetail(closedTrades[${idx}])" title="Click for details" style="cursor:pointer">
                    <td><strong>${t.pair}</strong></td>
                    <td><span class="signal-badge badge-${t.direction}">${t.direction}</span></td>
                    <td>${fmt(t.entry_price)}</td>
                    <td>${fmt(t.exit_price)}</td>
                    <td>${t.quantity}</td>
                    <td class="${t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${t.pnl >= 0 ? '+' : ''}${fmt(t.pnl)}</td>
                    <td class="${pctReturn >= 0 ? 'pnl-positive' : 'pnl-negative'}">${pctReturn >= 0 ? '+' : ''}${pctReturn.toFixed(2)}%</td>
                    <td>${duration}</td>
                    <td>${new Date(t.closed_at).toLocaleString()}</td>
                </tr>`;
                }).join('') + '</tbody></table></div>';
        } catch (err) { console.error('History error:', err); }
    }

    // Place trade
    async function placeTrade(direction) {
        const pair = document.getElementById('tradePair').value;
        const quantity = parseFloat(document.getElementById('tradeQty').value);
        const stop_loss = parseFloat(document.getElementById('tradeSL').value) || undefined;
        const take_profit = parseFloat(document.getElementById('tradeTP').value) || undefined;

        if (!quantity || quantity <= 0) { showToast('Enter a valid quantity', 'error'); return; }

        try {
            const res = await fetch(API + '/api/trade/open', {
                method: 'POST',
                headers: headers(),
                body: JSON.stringify({ pair, direction, quantity, stop_loss, take_profit })
            });
            const data = await res.json();
            if (!res.ok) { showToast(data.error, 'error'); return; }
            showToast(`${direction.toUpperCase()} position opened: ${pair} x${quantity}`);
            loadPositions();
            loadPortfolio();
        } catch (err) { showToast('Trade failed: ' + err.message, 'error'); }
    }

    // Close trade
    async function closeTrade(id) {
        try {
            const res = await fetch(API + '/api/trade/close/' + id, {
                method: 'POST',
                headers: headers()
            });
            const data = await res.json();
            if (!res.ok) { showToast(data.error, 'error'); return; }
            const pnl = data.trade.pnl >= 0 ? '+' + fmt(data.trade.pnl) : fmt(data.trade.pnl);
            showToast(`Position closed. P&L: ${pnl}`, data.trade.pnl >= 0 ? 'success' : 'error');
            loadPositions();
            loadHistory();
            loadPortfolio();
        } catch (err) { showToast('Close failed: ' + err.message, 'error'); }
    }

    // Update ticker display
    function updateTickers(tickers) {
        Object.assign(latestTickers, tickers);
        for (const [pair, data] of Object.entries(tickers)) {
            if (pair === 'BTC/EUR') {
                document.getElementById('btcPrice').textContent = fmt(data.price);
                const el = document.getElementById('btcChange');
                el.textContent = (data.change_24h >= 0 ? '\u25B2 +' : '\u25BC ') + data.change_24h.toFixed(2) + '% (24h)';
                el.className = 'ticker-change ' + (data.change_24h >= 0 ? 'green' : 'red');
            }
            if (pair === 'ETH/EUR') {
                document.getElementById('ethPrice').textContent = fmt(data.price);
                const el = document.getElementById('ethChange');
                el.textContent = (data.change_24h >= 0 ? '\u25B2 +' : '\u25BC ') + data.change_24h.toFixed(2) + '% (24h)';
                el.className = 'ticker-change ' + (data.change_24h >= 0 ? 'green' : 'red');
            }
        }
        // Re-render positions with updated prices
        if (openPositions.length > 0) renderPositions();
    }

    // Update signals display
    function updateSignals(signals) {
        const container = document.getElementById('signalsList');
        const html = Object.entries(signals).map(([pair, s]) => {
            if (!s) return '';
            const badgeClass = s.direction === 'long' ? 'badge-long' : s.direction === 'short' ? 'badge-short' : 'badge-hold';
            const isLLM = s.analysis_source === 'llm';

            let card = `<div class="signal-card">
                <div class="signal-top">
                    <span class="signal-pair">${s.pair}</span>
                    <span class="signal-badge ${badgeClass}">${s.direction} ${s.confidence}%</span>
                </div>
                <div class="signal-confidence">Price at signal: ${fmt(s.price_at_signal || s.price)}</div>`;

            if (isLLM) {
                // Meta badges: sentiment + risk + AI badge
                card += `<div class="signal-meta">`;
                if (s.market_sentiment) {
                    card += `<span class="signal-sentiment sentiment-${s.market_sentiment}">${s.market_sentiment}</span>`;
                }
                if (s.risk_level) {
                    card += `<span class="risk-badge risk-${s.risk_level}">Risk: ${s.risk_level}</span>`;
                }
                card += `<span class="ai-badge">AI Analysis</span>`;
                if (s.long_score != null && (s.bearish_risk_score != null || s.short_score != null)) {
                    const riskScore = s.bearish_risk_score != null ? s.bearish_risk_score : s.short_score;
                    card += `<span class="ai-badge" style="background:rgba(62,207,142,0.15);color:var(--accent-green);">L:${s.long_score}</span>`;
                    card += `<span class="ai-badge" style="background:rgba(248,113,113,0.15);color:var(--accent-red);">Risk:${riskScore}</span>`;
                }
                card += `</div>`;

                // Analysis text
                if (s.analysis_text) {
                    card += `<div class="signal-analysis">${escapeHtml(s.analysis_text)}</div>`;
                }

                // Key factors
                const factors = Array.isArray(s.key_factors) ? s.key_factors : [];
                if (factors.length > 0) {
                    card += `<div class="signal-factors">`;
                    factors.forEach(f => { card += `<span class="signal-factor-tag">${escapeHtml(f)}</span>`; });
                    card += `</div>`;
                }

                // Global Liquidity assessment
                if (s.global_liquidity_assessment) {
                    card += `<div class="signal-liquidity">
                        <div class="signal-liquidity-label">Global Liquidity</div>
                        ${escapeHtml(s.global_liquidity_assessment)}
                    </div>`;
                }

                // Price levels
                if (s.suggested_entry || s.suggested_stop_loss || s.suggested_take_profit) {
                    card += `<div class="signal-levels">`;
                    if (s.suggested_entry) {
                        card += `<div class="signal-level-item"><div class="signal-level-label">Entry</div><div class="signal-level-value">${fmt(s.suggested_entry)}</div></div>`;
                    }
                    if (s.suggested_stop_loss) {
                        card += `<div class="signal-level-item"><div class="signal-level-label">Stop Loss</div><div class="signal-level-value red">${fmt(s.suggested_stop_loss)}</div></div>`;
                    }
                    if (s.suggested_take_profit) {
                        card += `<div class="signal-level-item"><div class="signal-level-label">Take Profit</div><div class="signal-level-value green">${fmt(s.suggested_take_profit)}</div></div>`;
                    }
                    card += `</div>`;
                }
            } else {
                // Legacy display
                const indicators = s.indicators || {};
                const rsiVal = s.rsi || indicators.rsi;
                const macdVal = s.macd || indicators.macd;
                if (rsiVal || macdVal) {
                    card += `<div class="signal-indicators">`;
                    if (rsiVal) card += `<span>RSI: ${parseFloat(rsiVal).toFixed(1)}</span>`;
                    if (macdVal) card += `<span>MACD: ${parseFloat(macdVal).toFixed(4)}</span>`;
                    card += `</div>`;
                }
            }

            card += `</div>`;
            return card;
        }).join('');
        container.innerHTML = html || '<div class="empty-state">Waiting for signals...</div>';
        document.getElementById('signalTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    function showSignalError(errorMsg) {
        const container = document.getElementById('signalsList');
        container.innerHTML = `<div class="signal-error">${escapeHtml(errorMsg)}</div>`;
        document.getElementById('signalTime').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // Position detail modal
    function showPositionDetail(posId) {
        const p = openPositions.find(pos => pos.id === posId);
        if (!p) return;
        const curPrice = getCurrentPriceForPair(p.pair);
        const pnl = curPrice ? calcUnrealizedPnl(p, curPrice) : null;
        const pnlPct = pnl !== null ? calcPnlPercent(p, pnl) : null;
        const invested = p.entry_price * p.quantity;
        const holdTime = formatDuration(p.created_at, new Date().toISOString());

        const modal = document.getElementById('posDetailModal');
        document.getElementById('posDetailContent').innerHTML = `
            <div class="modal-header">
                <h3>${p.pair} <span class="signal-badge badge-${p.direction}" style="margin-left:8px;">${p.direction}</span></h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-grid">
                ${pnl !== null ? `<div class="pnl-banner ${pnl >= 0 ? 'positive' : 'negative'}">
                    <div class="pnl-amount ${pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${pnl >= 0 ? '+' : ''}${fmt(pnl)}</div>
                    <div class="pnl-percent ${pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(2)}% return</div>
                </div>` : ''}
                <div class="detail-item">
                    <div class="detail-label">Entry Price</div>
                    <div class="detail-value">${fmt(p.entry_price)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Current Price</div>
                    <div class="detail-value">${curPrice ? fmt(curPrice) : '--'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Quantity</div>
                    <div class="detail-value">${p.quantity}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Invested</div>
                    <div class="detail-value">${fmt(invested)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Current Value</div>
                    <div class="detail-value">${curPrice ? fmt(curPrice * p.quantity) : '--'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Hold Duration</div>
                    <div class="detail-value">${holdTime}</div>
                </div>
                <div class="detail-divider"></div>
                <div class="detail-item">
                    <div class="detail-label">Stop Loss</div>
                    <div class="detail-value">${p.stop_loss ? fmt(p.stop_loss) : 'Not set'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Take Profit</div>
                    <div class="detail-value">${p.take_profit ? fmt(p.take_profit) : 'Not set'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Opened</div>
                    <div class="detail-value" style="font-size:13px;">${new Date(p.created_at).toLocaleString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Trade ID</div>
                    <div class="detail-value">#${p.id}</div>
                </div>
            </div>
            <div style="margin-top:20px;text-align:center;">
                <button class="btn-close-pos" style="padding:10px 32px;font-size:14px;" onclick="closeDetailModal();closeTrade(${p.id})">Close Position</button>
            </div>
        `;
        modal.classList.add('active');
    }

    function showHistoryDetail(tradeStr) {
        const t = typeof tradeStr === 'string' ? JSON.parse(tradeStr) : tradeStr;
        const invested = t.entry_price * t.quantity;
        const pctReturn = invested > 0 ? (t.pnl / invested) * 100 : 0;
        const duration = t.created_at && t.closed_at ? formatDuration(t.created_at, t.closed_at) : '-';

        const modal = document.getElementById('posDetailModal');
        document.getElementById('posDetailContent').innerHTML = `
            <div class="modal-header">
                <h3>${t.pair} <span class="signal-badge badge-${t.direction}" style="margin-left:8px;">${t.direction}</span> <span style="font-size:12px;color:var(--text-secondary);font-weight:400;margin-left:8px;">CLOSED</span></h3>
                <button class="modal-close" onclick="closeDetailModal()">&times;</button>
            </div>
            <div class="detail-grid">
                <div class="pnl-banner ${t.pnl >= 0 ? 'positive' : 'negative'}">
                    <div class="pnl-amount ${t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${t.pnl >= 0 ? '+' : ''}${fmt(t.pnl)}</div>
                    <div class="pnl-percent ${pctReturn >= 0 ? 'pnl-positive' : 'pnl-negative'}">${pctReturn >= 0 ? '+' : ''}${pctReturn.toFixed(2)}% return</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Entry Price</div>
                    <div class="detail-value">${fmt(t.entry_price)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Exit Price</div>
                    <div class="detail-value">${fmt(t.exit_price)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Quantity</div>
                    <div class="detail-value">${t.quantity}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Invested</div>
                    <div class="detail-value">${fmt(invested)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Returned</div>
                    <div class="detail-value">${fmt(invested + t.pnl)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Hold Duration</div>
                    <div class="detail-value">${duration}</div>
                </div>
                <div class="detail-divider"></div>
                <div class="detail-item">
                    <div class="detail-label">Opened</div>
                    <div class="detail-value" style="font-size:13px;">${new Date(t.created_at).toLocaleString()}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Closed</div>
                    <div class="detail-value" style="font-size:13px;">${new Date(t.closed_at).toLocaleString()}</div>
                </div>
            </div>
        `;
        modal.classList.add('active');
    }

    function closeDetailModal() {
        document.getElementById('posDetailModal').classList.remove('active');
    }

    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeDetailModal(); });

    // WebSocket connection
    function connectWS() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(protocol + '//' + location.host + '/ws');

        ws.onopen = () => {
            document.getElementById('wsDot').classList.add('connected');
            document.getElementById('wsLabel').textContent = 'Live';
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (msg.type === 'ticker') updateTickers(msg.data);
            if (msg.type === 'signals') {
                if (msg.error) {
                    showSignalError(msg.error);
                } else if (msg.data) {
                    updateSignals(msg.data);
                }
            }
        };

        ws.onclose = () => {
            document.getElementById('wsDot').classList.remove('connected');
            document.getElementById('wsLabel').textContent = 'Reconnecting...';
            setTimeout(connectWS, 3000);
        };

        ws.onerror = () => ws.close();
    }

    // Load initial signals from REST API
    async function loadSignals() {
        try {
            const res = await fetch(API + '/api/signals/latest');
            const data = await res.json();
            updateSignals(data.signals);
        } catch (err) { console.error('Signals error:', err); }
    }

    // Manual signal refresh
    async function manualRefreshSignals() {
        const btn = document.getElementById('refreshSignalsBtn');
        btn.disabled = true;
        btn.textContent = 'Generating...';
        btn.style.opacity = '0.5';
        try {
            const res = await fetch(API + '/api/signals/refresh', { method: 'POST', headers: headers() });
            const data = await res.json();
            if (!res.ok) {
                showToast(data.error || 'Refresh failed', 'error');
                return;
            }
            updateSignals(data.signals);
            showToast('Signals refreshed');
        } catch (err) {
            showToast('Refresh failed: ' + err.message, 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '&#x21bb; Refresh';
            btn.style.opacity = '1';
        }
    }

    // Initial ticker load from REST
    async function loadTickers() {
        try {
            const res = await fetch(API + '/api/market/ticker');
            const data = await res.json();
            Object.assign(latestTickers, data.tickers);
            updateTickers(data.tickers);
        } catch (err) { console.error('Ticker error:', err); }
    }

    //  Analytics Charts 
    let analyticsData = null;

    function setupCanvas(canvas, width, height) {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = width * dpr;
        canvas.height = height * dpr;
        canvas.style.width = width + 'px';
        canvas.style.height = height + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
        return ctx;
    }

    function drawDonutChart(donut, winRate) {
        const canvas = document.getElementById('donutCanvas');
        const size = 140;
        const ctx = setupCanvas(canvas, size, size);
        const cx = size / 2, cy = size / 2, r = 54, lineW = 14;
        const total = donut.wins + donut.losses + donut.breakeven;
        ctx.clearRect(0, 0, size, size);
        if (total === 0) return;

        const slices = [
            { val: donut.wins, color: '#3ecf8e' },
            { val: donut.breakeven, color: '#7a8a8a' },
            { val: donut.losses, color: '#f87171' }
        ];
        let angle = -Math.PI / 2;
        for (const s of slices) {
            if (s.val === 0) continue;
            const sweep = (s.val / total) * Math.PI * 2;
            ctx.beginPath();
            ctx.arc(cx, cy, r, angle, angle + sweep);
            ctx.strokeStyle = s.color;
            ctx.lineWidth = lineW;
            ctx.lineCap = 'butt';
            ctx.stroke();
            angle += sweep;
        }
        document.getElementById('donutPct').textContent = winRate.toFixed(0) + '%';
    }

    function drawPnlChart(timeline) {
        const canvas = document.getElementById('pnlCanvas');
        const w = canvas.parentElement.clientWidth - 40;
        const h = 170;
        const ctx = setupCanvas(canvas, w, h);
        ctx.clearRect(0, 0, w, h);
        if (timeline.length === 0) return;

        const pad = { top: 10, right: 10, bottom: 28, left: 50 };
        const cw = w - pad.left - pad.right;
        const ch = h - pad.top - pad.bottom;

        const values = timeline.map(d => d.cumulative_pnl);
        const minV = Math.min(0, ...values);
        const maxV = Math.max(0, ...values);
        const range = maxV - minV || 1;

        function x(i) { return pad.left + (i / (timeline.length - 1 || 1)) * cw; }
        function y(v) { return pad.top + ch - ((v - minV) / range) * ch; }

        // Zero line
        const zeroY = y(0);
        ctx.strokeStyle = '#1e2e2e';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(pad.left, zeroY); ctx.lineTo(w - pad.right, zeroY); ctx.stroke();
        ctx.setLineDash([]);

        // Area fill
        ctx.beginPath();
        ctx.moveTo(x(0), zeroY);
        for (let i = 0; i < timeline.length; i++) ctx.lineTo(x(i), y(values[i]));
        ctx.lineTo(x(timeline.length - 1), zeroY);
        ctx.closePath();
        const lastVal = values[values.length - 1];
        const grad = ctx.createLinearGradient(0, pad.top, 0, h);
        if (lastVal >= 0) { grad.addColorStop(0, 'rgba(62,207,142,0.25)'); grad.addColorStop(1, 'rgba(62,207,142,0)'); }
        else { grad.addColorStop(0, 'rgba(248,113,113,0)'); grad.addColorStop(1, 'rgba(248,113,113,0.25)'); }
        ctx.fillStyle = grad;
        ctx.fill();

        // Line
        ctx.beginPath();
        for (let i = 0; i < timeline.length; i++) {
            if (i === 0) ctx.moveTo(x(i), y(values[i]));
            else ctx.lineTo(x(i), y(values[i]));
        }
        ctx.strokeStyle = lastVal >= 0 ? '#3ecf8e' : '#f87171';
        ctx.lineWidth = 2;
        ctx.stroke();

        // Date labels
        ctx.fillStyle = '#7a8a8a';
        ctx.font = '10px -apple-system, sans-serif';
        ctx.textAlign = 'center';
        const step = Math.max(1, Math.floor(timeline.length / 5));
        for (let i = 0; i < timeline.length; i += step) {
            const d = timeline[i].date;
            ctx.fillText(d.slice(5), x(i), h - 4);
        }
        // Last date always
        if (timeline.length > 1) {
            ctx.fillText(timeline[timeline.length - 1].date.slice(5), x(timeline.length - 1), h - 4);
        }

        // Y-axis labels
        ctx.textAlign = 'right';
        ctx.fillText(maxV.toFixed(0), pad.left - 6, pad.top + 10);
        ctx.fillText(minV.toFixed(0), pad.left - 6, pad.top + ch);
        if (minV < 0 && maxV > 0) ctx.fillText('0', pad.left - 6, zeroY + 4);
    }

    function drawPairChart(byPair) {
        const canvas = document.getElementById('pairCanvas');
        const pairs = Object.entries(byPair);
        const w = canvas.parentElement.clientWidth - 40;
        const h = 150;
        const ctx = setupCanvas(canvas, w, h);
        ctx.clearRect(0, 0, w, h);
        if (pairs.length === 0) return;

        const pad = { top: 5, right: 10, bottom: 5, left: 70 };
        const cw = w - pad.left - pad.right;
        const ch = h - pad.top - pad.bottom;
        const barH = Math.min(28, ch / pairs.length - 6);
        const gap = (ch - barH * pairs.length) / (pairs.length + 1);

        for (let i = 0; i < pairs.length; i++) {
            const [pair, stats] = pairs[i];
            const yPos = pad.top + gap * (i + 1) + barH * i;
            const barW = (stats.win_rate / 100) * cw;

            // Bar
            ctx.fillStyle = stats.win_rate >= 50 ? 'rgba(62,207,142,0.6)' : 'rgba(248,113,113,0.6)';
            ctx.beginPath();
            ctx.roundRect(pad.left, yPos, Math.max(barW, 2), barH, 4);
            ctx.fill();

            // Label
            ctx.fillStyle = '#f0f0f0';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(pair, pad.left - 8, yPos + barH / 2 + 4);

            // Value
            ctx.fillStyle = '#7a8a8a';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText(stats.win_rate.toFixed(0) + '% (' + stats.wins + 'W/' + stats.losses + 'L)', pad.left + barW + 8, yPos + barH / 2 + 4);
        }
    }

    function drawDirectionChart(byDir) {
        const canvas = document.getElementById('dirCanvas');
        const w = canvas.parentElement.clientWidth - 40;
        const h = 150;
        const ctx = setupCanvas(canvas, w, h);
        ctx.clearRect(0, 0, w, h);

        const dirs = [
            { label: 'LONG', data: byDir.long, color: '#3ecf8e' },
            { label: 'SHORT', data: byDir.short, color: '#f87171' }
        ];
        const pad = { top: 10, right: 20, bottom: 28, left: 20 };
        const cw = w - pad.left - pad.right;
        const ch = h - pad.top - pad.bottom;
        const barW = Math.min(60, cw / 4);
        const gap = (cw - barW * 2) / 3;

        for (let i = 0; i < dirs.length; i++) {
            const d = dirs[i];
            const total = d.data.wins + d.data.losses;
            const rate = total > 0 ? d.data.win_rate : 0;
            const barH = (rate / 100) * ch;
            const xPos = pad.left + gap * (i + 1) + barW * i;
            const yPos = pad.top + ch - barH;

            ctx.fillStyle = d.color + '99';
            ctx.beginPath();
            ctx.roundRect(xPos, yPos, barW, barH, [4, 4, 0, 0]);
            ctx.fill();

            // Value on bar
            ctx.fillStyle = '#f0f0f0';
            ctx.font = 'bold 14px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(rate.toFixed(0) + '%', xPos + barW / 2, yPos - 6);

            // Label
            ctx.fillStyle = '#7a8a8a';
            ctx.font = '11px -apple-system, sans-serif';
            ctx.fillText(d.label, xPos + barW / 2, h - 10);

            // W/L count
            ctx.font = '10px -apple-system, sans-serif';
            ctx.fillText(d.data.wins + 'W/' + d.data.losses + 'L', xPos + barW / 2, h - 0);
        }
    }

    function drawCalibrationChart(calibration) {
        const canvas = document.getElementById('calibCanvas');
        const w = canvas.parentElement.clientWidth - 40;
        const h = 150;
        const ctx = setupCanvas(canvas, w, h);
        ctx.clearRect(0, 0, w, h);

        const buckets = calibration.filter(b => b.trades > 0);
        if (buckets.length === 0) {
            ctx.fillStyle = '#7a8a8a';
            ctx.font = '12px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Need trades with confidence data', w / 2, h / 2);
            return;
        }

        const pad = { top: 10, right: 10, bottom: 28, left: 10 };
        const cw = w - pad.left - pad.right;
        const ch = h - pad.top - pad.bottom;
        const barW = Math.min(40, cw / calibration.length - 10);
        const gap = (cw - barW * calibration.length) / (calibration.length + 1);

        for (let i = 0; i < calibration.length; i++) {
            const b = calibration[i];
            const barH = b.trades > 0 ? (b.win_rate / 100) * ch : 0;
            const xPos = pad.left + gap * (i + 1) + barW * i;
            const yPos = pad.top + ch - barH;

            // Bar
            if (b.trades > 0) {
                ctx.fillStyle = 'rgba(167,139,250,0.5)';
                ctx.beginPath();
                ctx.roundRect(xPos, yPos, barW, barH, [4, 4, 0, 0]);
                ctx.fill();

                // Win rate on top
                ctx.fillStyle = '#f0f0f0';
                ctx.font = 'bold 11px -apple-system, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(b.win_rate.toFixed(0) + '%', xPos + barW / 2, yPos - 4);
            }

            // Bucket label
            ctx.fillStyle = '#7a8a8a';
            ctx.font = '10px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(b.bucket, xPos + barW / 2, h - 6);
        }

        // Perfect calibration reference line (diagonal)
        ctx.strokeStyle = '#a78bfa';
        ctx.lineWidth = 1.5;
        ctx.setLineDash([4, 4]);
        ctx.beginPath();
        for (let i = 0; i < calibration.length; i++) {
            const xPos = pad.left + gap * (i + 1) + barW * i + barW / 2;
            const expectedH = (calibration[i].expected_midpoint / 100) * ch;
            const yPos = pad.top + ch - expectedH;
            if (i === 0) ctx.moveTo(xPos, yPos);
            else ctx.lineTo(xPos, yPos);
        }
        ctx.stroke();
        ctx.setLineDash([]);
    }

    function renderStreak(streak) {
        const container = document.getElementById('streakContainer');
        if (streak.last_10.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--text-secondary);padding:20px;">No trades yet</div>';
            return;
        }
        let html = '<div class="streak-dots">';
        for (const r of streak.last_10) {
            const label = r === 'win' ? 'W' : r === 'loss' ? 'L' : 'E';
            html += `<div class="streak-dot ${r}">${label}</div>`;
        }
        html += '</div>';
        html += '<div class="streak-info">';
        if (streak.type !== 'none') {
            html += `Current: <strong>${streak.count} ${streak.type}${streak.count > 1 ? 's' : ''}</strong> streak`;
        }
        html += '</div>';
        container.innerHTML = html;
    }

    async function loadAnalytics() {
        try {
            const res = await fetch(API + '/api/portfolio/analytics', { headers: headers() });
            const data = await res.json();
            analyticsData = data.analytics;

            if (analyticsData.total_trades === 0) {
                document.getElementById('analyticsEmpty').style.display = 'block';
                document.getElementById('analyticsContent').style.display = 'none';
                return;
            }
            document.getElementById('analyticsEmpty').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';

            drawDonutChart(analyticsData.donut, analyticsData.win_rate);
            renderStreak(analyticsData.recent_streak);
            drawPnlChart(analyticsData.pnl_timeline);
            drawPairChart(analyticsData.by_pair);
            drawDirectionChart(analyticsData.by_direction);
            drawCalibrationChart(analyticsData.confidence_calibration);
        } catch (err) { console.error('Analytics error:', err); }
    }

    function redrawAnalytics() {
        if (!analyticsData || analyticsData.total_trades === 0) return;
        drawPnlChart(analyticsData.pnl_timeline);
        drawPairChart(analyticsData.by_pair);
        drawDirectionChart(analyticsData.by_direction);
        drawCalibrationChart(analyticsData.confidence_calibration);
    }

    window.addEventListener('resize', redrawAnalytics);

    // Register service worker for PWA
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // Init
    loadUser();
    loadPortfolio();
    loadPositions();
    loadHistory();
    loadTickers();
    loadSignals();
    loadAnalytics();
    connectWS();

    // Refresh portfolio every 30s
    setInterval(() => { loadPortfolio(); loadPositions(); loadAnalytics(); }, 30000);
    </script>
</body>
</html>
